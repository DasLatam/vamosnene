---
import Base from "../layouts/Base.astro";

const api = import.meta.env.PUBLIC_API_BASE;

let now: any = null;
let news: any = null;

async function safeJson(url: string) {
  try {
    const r = await fetch(url, { headers: { "accept": "application/json" } });
    if (!r.ok) return null;
    return await r.json();
  } catch { return null; }
}

if (api) {
  now = await safeJson(`${api}/api/now`);
  news = await safeJson(`${api}/api/news`);
}

function fmtAR(iso?: string) {
  if (!iso) return "";
  const d = new Date(iso);
  if (isNaN(d.getTime())) return String(iso);
  return new Intl.DateTimeFormat("es-AR", { dateStyle:"medium", timeStyle:"short", timeZone:"America/Argentina/Buenos_Aires" }).format(d);
}

const items = Array.isArray(news?.items) ? news.items.slice(0, 10) : [];
---
<Base layout="dashboard" title="Vivo — Dashboard F1 (ARG) · Vamos Nene...!!!" description="Dashboard estilo F1: estado, horarios ARG, ticker y mapa (beta).">
  <h1 style="margin-top:6px">Dashboard Vivo</h1>
  <p class="muted" style="margin-top:6px">
    Si entrás acá es para saber <strong>qué está pasando</strong>, <strong>a qué hora</strong> y <strong>qué mirar</strong>. Modo “panel” tipo F1.
  </p>

  <div class="dashLayout">
    <!-- LEFT: leaderboard placeholder (para retención visual) -->
    <div class="card">
      <div class="row" style="justify-content:space-between">
        <strong>Tabla (beta)</strong>
        <span class="badge"><span class="dot"></span> Testing / GP</span>
      </div>
      <p class="muted small" style="margin-top:10px">
        En plan gratis, sin feed oficial de posiciones en tiempo real. Igual dejamos el layout listo.
      </p>

      <div class="sideList" style="margin-top:10px">
        {["NOR","VER","LEC","RUS","HAM","PIA","ALO","SAI","PER","COL"].map((c,i)=>(
          <div class="driverRow">
            <div class="row" style="gap:10px">
              <span class="driverTag">{String(i+1).padStart(2,"0")}</span>
              <div>
                <div class="driverName">{c}</div>
                <div class="muted small">stint —</div>
              </div>
            </div>
            <div class="muted small kpi">—</div>
          </div>
        ))}
      </div>
    </div>

    <!-- CENTER: track -->
    <div class="trackBox">
      <div class="trackTop">
        <div class="row">
          <span class="badge">{now?.current ? "EN VIVO" : (now?.next ? "PRÓXIMO" : "SIN DATOS")}</span>
          <span class="badge">Horario ARG: <span class="kpi">{now?.current ? fmtAR(now.current.start_time) : (now?.next ? fmtAR(now.next.start_time) : "—")}</span></span>
        </div>
        <div class="row">
          <a class="btn" href="/calendario/2026">Calendario</a>
          <a class="btn primary" href="/noticias">Noticias</a>
        </div>
      </div>

      <div class="trackCanvasWrap">
        <canvas id="track" width="980" height="520" style="width:100%;height:auto;display:block"></canvas>
      </div>

      <div class="muted small" style="padding:0 14px 14px">
        Mapa (beta): visual tipo F1. Si tu API expone posiciones (ej: OpenF1 con token), acá se anima “en vivo”.
      </div>
    </div>

    <!-- RIGHT: panels -->
    <div>
      <div class="card">
        <strong>Contexto de la jornada</strong>
        <div class="hr"></div>
        <p class="muted"><strong>Ahora:</strong> {now?.current ? `${now.current.event_name} — ${now.current.session_name}` : "—"}</p>
        <p class="muted"><strong>Ventana:</strong> {now?.current ? `${fmtAR(now.current.start_time)} → ${fmtAR(now.current.end_time)}` : "—"}</p>
        <p class="muted"><strong>Próximo:</strong> {now?.next ? `${now.next.event_name} — ${now.next.session_name} · ${fmtAR(now.next.start_time)}` : "—"}</p>
        <div class="row" style="margin-top:10px">
          <a class="btn alpine" href="/suscribirme">Avisos 72hs antes</a>
        </div>
      </div>

      <div class="card">
        <strong>Ticker (Colapinto)</strong>
        <div class="hr"></div>
        {items.length ? (
          <div style="display:flex;flex-direction:column;gap:10px">
            {items.map((n:any)=>(
              <div style="padding:10px 12px;border-radius:14px;border:1px solid rgba(255,255,255,.12);background:rgba(255,255,255,.06)">
                <div class="muted small">{n.source || "Fuente"}</div>
                <div style="font-weight:950;margin-top:6px">{n.title || "—"}</div>
              </div>
            ))}
          </div>
        ) : (
          <p class="muted">Sin noticias cacheadas aún.</p>
        )}
      </div>

      <div class="card">
        <strong>Dónde verlo (ARG)</strong>
        <div class="hr"></div>
        <p class="muted small">
          MVP: bloque informativo. Próximo paso: tabla por proveedor (Flow/DGO/Telecentro/Movistar/Disney+) por sesión.
        </p>
        <ul class="muted small">
          <li>TV: ESPN / Fox Sports (según derechos vigentes)</li>
          <li>Streaming: Disney+ (según derechos vigentes)</li>
        </ul>
      </div>
    </div>
  </div>

  <script type="module">
    // Track placeholder: estilo F1 (pista + glow). Si mañana tenés posiciones reales, acá se reemplaza por fetch+animación.
    const c = document.getElementById("track");
    const ctx = c.getContext("2d");

    function draw(){
      const W = c.width, H = c.height;
      ctx.clearRect(0,0,W,H);

      // fondo
      ctx.fillStyle = "rgba(0,0,0,0)";
      ctx.fillRect(0,0,W,H);

      // pista fake (loop)
      const pts = [];
      for(let t=0;t<Math.PI*2;t+=0.02){
        const x = W/2 + Math.cos(t)*330 + Math.cos(t*3)*50;
        const y = H/2 + Math.sin(t)*180 + Math.sin(t*2)*40;
        pts.push([x,y]);
      }

      // glow
      ctx.lineWidth = 18;
      ctx.strokeStyle = "rgba(255,255,255,0.10)";
      ctx.lineJoin = "round";
      ctx.lineCap = "round";
      ctx.beginPath();
      pts.forEach(([x,y],i)=> i?ctx.lineTo(x,y):ctx.moveTo(x,y));
      ctx.closePath();
      ctx.stroke();

      // track
      ctx.lineWidth = 7;
      ctx.strokeStyle = "rgba(255,255,255,0.75)";
      ctx.beginPath();
      pts.forEach(([x,y],i)=> i?ctx.lineTo(x,y):ctx.moveTo(x,y));
      ctx.closePath();
      ctx.stroke();

      // marker #43
      const p = pts[Math.floor(pts.length*0.72)];
      ctx.beginPath();
      ctx.fillStyle = "rgba(103,183,255,0.28)";
      ctx.arc(p[0],p[1], 18, 0, Math.PI*2);
      ctx.fill();

      ctx.beginPath();
      ctx.fillStyle = "rgba(255,255,255,0.92)";
      ctx.arc(p[0],p[1], 6, 0, Math.PI*2);
      ctx.fill();

      ctx.font = "900 16px ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, 'Liberation Mono', 'Courier New', monospace";
      ctx.fillStyle = "rgba(255,255,255,0.85)";
      ctx.fillText("43", p[0]+12, p[1]-10);
    }

    draw();
    addEventListener("resize", draw);
  </script>
</Base>
