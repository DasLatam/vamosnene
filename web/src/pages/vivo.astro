---
import Base from "../layouts/Base.astro";
const api = import.meta.env.PUBLIC_API_BASE;

const now = await fetch(`${api}/api/now`).then(r=>r.json()).catch(()=>({}));
const weather = await fetch(`${api}/api/weather`).then(r=>r.json()).catch(()=>({}));
const newsAll = await fetch(`${api}/api/news`).then(r=>r.json()).catch(()=>({items:[]}));
const items = Array.isArray(newsAll.items) ? newsAll.items : [];

const focus = items.filter(it=>{
  const s = `${it.title||""} ${it.snippet||""} ${it.tags||""}`.toLowerCase();
  return s.includes("colapinto") || s.includes("alpine");
}).slice(0,8);

function fmtAR(iso){
  if(!iso) return "‚Äî";
  const d = new Date(iso); if(isNaN(d.getTime())) return String(iso);
  return new Intl.DateTimeFormat("es-AR", { dateStyle:"medium", timeStyle:"short", timeZone:"America/Argentina/Buenos_Aires" }).format(d);
}
const current = now?.current || null;
const next = now?.next || null;
const live = !!current;
const title = live ? `${current.event_name} ‚Äî ${current.session_name}` : (next ? `${next.event_name} ‚Äî ${next.session_name}` : "Vivo");
const updated = fmtAR(now?.now);

const w = weather?.weather;
---
<Base title={`Vivo ‚Äî ${title}`} description="Dashboard argentino: qu√© pasa hoy, clima, horarios y contexto.">
  <h1 style="margin: 10px 0 6px">Vivo</h1>
  <p class="muted" style="margin:0">
    Esto es un ‚Äúpit wall‚Äù argentino: <b>estado</b>, <b>horarios ARG</b>, <b>d√≥nde verlo</b>, <b>clima</b> y <b>noticias del d√≠a</b>.
  </p>

  <div class="dash" style="margin-top:14px">
    <div class="dashTop">
      <div style="display:flex;flex-wrap:wrap;gap:10px;align-items:center">
        <span class="pillD">{live ? "üü¢ EN VIVO" : "üü° PR√ìXIMO"}</span>
        <span class="pillD"><b>{title}</b></span>
        <span class="pillD">Actualizado: <span class="mono">{updated}</span></span>
      </div>
      <div style="display:flex;flex-wrap:wrap;gap:10px;align-items:center">
        <span class="pillD">ARG</span>
        <span class="pillD">#43</span>
      </div>
    </div>

    <div class="dashBody">
      <!-- IZQ: ‚Äútabla‚Äù -->
      <aside class="dashCol">
        <div class="pillD" style="margin-bottom:10px">Resumen de jornada</div>
        <div class="list">
          <div class="rowD">
            <div>
              <div class="tag">Ahora</div>
              <div style="opacity:.78;font-size:12px">{current ? current.session_name : "‚Äî"}</div>
            </div>
            <div class="mono">{current ? fmtAR(current.start_time).split(", ").pop() : "‚Äî"}</div>
          </div>

          <div class="rowD">
            <div>
              <div class="tag">Pr√≥ximo</div>
              <div style="opacity:.78;font-size:12px">{next ? next.session_name : "‚Äî"}</div>
            </div>
            <div class="mono">{next ? fmtAR(next.start_time).split(", ").pop() : "‚Äî"}</div>
          </div>

          <div class="rowD">
            <div>
              <div class="tag">D√≥nde verlo</div>
              <div style="opacity:.78;font-size:12px">Gu√≠a (ARG)</div>
            </div>
            <a class="pillD" href="/guias/como-ver-f1-en-argentina">Abrir</a>
          </div>

          <div class="rowD">
            <div>
              <div class="tag">Calendario</div>
              <div style="opacity:.78;font-size:12px">Temporada 2026</div>
            </div>
            <a class="pillD" href="/calendario/2026">Ver</a>
          </div>
        </div>
      </aside>

      <!-- CENTRO: ‚Äúvisual‚Äù (placeholder listo para track map real cuando haya feed) -->
      <section class="dashCol">
        <div class="pillD" style="margin-bottom:10px">Centro (visual)</div>
        <div class="rowD" style="justify-content:space-between">
          <div>
            <div class="tag">Mapa / Track</div>
            <div style="opacity:.78;font-size:12px">Cuando haya feed, ac√° va el track map tipo f1-dash</div>
          </div>
          <div class="bigTime">{live ? "LIVE" : "NEXT"}</div>
        </div>
        <div style="margin-top:12px;opacity:.9;font-size:13px">
          <b>Qu√© vas a ver ac√° (V2):</b>
          <ul style="margin:8px 0 0;padding-left:18px;opacity:.82">
            <li>Track map + puntos (si hay datos)</li>
            <li>Tabla izquierda con ‚Äúestado‚Äù y foco #43</li>
            <li>Contexto derecha: clima + titulares del d√≠a</li>
          </ul>
        </div>
      </section>

      <!-- DER: contexto -->
      <aside class="dashCol">
        <div class="pillD" style="margin-bottom:10px">Contexto</div>

        <div class="rowD">
          <div>
            <div class="tag">Clima</div>
            <div style="opacity:.78;font-size:12px">{weather?.event_slug || "‚Äî"}</div>
          </div>
          <div class="mono">{w ? "OK" : "‚Äî"}</div>
        </div>

        <div style="margin-top:12px" class="pillD">Titulares (Colapinto/Alpine)</div>
        <div class="list" style="margin-top:10px">
          {focus.length ? focus.slice(0,5).map(n => (
            <a class="rowD" href="/noticias" style="text-decoration:none">
              <div style="min-width:0">
                <div style="font-weight:900;white-space:nowrap;overflow:hidden;text-overflow:ellipsis">{n.title}</div>
                <div style="opacity:.72;font-size:12px">{n.source_name || n.source_code || ""}</div>
              </div>
              <span class="pillD">‚Üí</span>
            </a>
          )) : (
            <div style="opacity:.78;font-size:12px">Sin suficientes items filtrados.</div>
          )}
        </div>
      </aside>
    </div>
  </div>

  <div class="grid">
    <div class="card">
      <h2>Qu√© es ‚ÄúVivo‚Äù</h2>
      <p class="muted" style="margin-top:0">
        Un panel para quedarte: refresca contexto (no s√≥lo links). Pr√≥ximo paso: track map real cuando haya fuente viable sin USD.
      </p>
      <div class="btns">
        <a class="btn primary" href="/suscribirme">Recibir avisos (72hs antes)</a>
        <a class="btn alpine" href="/noticias">Noticias del d√≠a</a>
      </div>
    </div>

    <div class="card">
      <h2>Disclaimer</h2>
      <p class="muted" style="margin-top:0">
        No oficial / no afiliado a F1. Las fuentes se acreditan. El objetivo es informar y contextualizar (ARG + #43).
      </p>
    </div>
  </div>
</Base>
