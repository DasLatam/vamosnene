---
import Base from "../layouts/Base.astro";
import TrackMap from "../components/TrackMap.astro";

const api = import.meta.env.PUBLIC_API_BASE;

const nowR = await fetch(`${api}/api/now`);
const now = await nowR.json();

const newsR = await fetch(`${api}/api/news?only_colapinto=1&limit=8&offset=0`);
const news = await newsR.json();

function fmt(iso){
  if(!iso) return "";
  const d = new Date(iso);
  if (isNaN(d.getTime())) return String(iso);
  return new Intl.DateTimeFormat("es-AR",{dateStyle:"full",timeStyle:"short",timeZone:"America/Argentina/Buenos_Aires"}).format(d);
}

const current = now?.current_event;
const sessions = now?.sessions || [];
const status = now?.status || "panel";
const next = now?.next_session;
const where = now?.where_to_watch || [];
---
<Base title="Vivo ‚Äî Vamos Nene...!!!" description="Panel en vivo: qu√© est√° pasando, horarios ARG, clima y noticias de Colapinto.">
  <section class="hero">
    <div class="heroInner">
      <div>
        <div class="kicker">üü£ Vivo ¬∑ Panel (ARG)</div>
        <h1 class="h1">Contexto en vivo</h1>
        <p class="p">
          Entr√°s para saber: <b>qu√© sesi√≥n es</b>, <b>horarios ARG</b>, <b>clima</b>, <b>d√≥nde verlo</b> y <b>qu√© noticias importan</b>.
        </p>

        <div style="display:flex;gap:10px;flex-wrap:wrap;">
          <span class={"badge " + (status === "live" ? "live" : status === "soon" ? "soon" : "")}>
            {status === "live" ? "EN VIVO" : status === "soon" ? "PR√ìXIMO" : "PANEL"}
          </span>
          <span class="badge">Actualizaci√≥n: {now?.meta?.last_sync ? fmt(now.meta.last_sync) : "‚Äî"}</span>
          <span class="badge">Fuentes: calendario (Ergast/Jolpica) ¬∑ clima (OpenWeather) ¬∑ noticias (RSS con cr√©dito)</span>
        </div>

        {current ? (
          <div style="margin-top:12px;" class="note">
            <strong>{current.name}</strong>
            <div>{current.circuit_name} ¬∑ {current.locality} ¬∑ {current.country}</div>
            {next ? <div style="margin-top:6px;"><b>Pr√≥ximo:</b> {next.name} ¬∑ {fmt(next.start_at)}</div> : null}
          </div>
        ) : null}
      </div>

      <div>
        <div class="card" style="height:100%;">
          <div class="cardHeader">
            <h2 class="cardTitle">D√≥nde verlo (Argentina)</h2>
            <p class="cardSub">Chequear disponibilidad por plan/operador.</p>
          </div>
          <div class="cardBody" style="display:grid;gap:10px;">
            {where.length ? where.map((w) => (
              <div class="badge">{w}</div>
            )) : (
              <div class="small">Configurable desde la API (por defecto: Disney+ / TV/cable).</div>
            )}
            <a class="btn alt" href="/suscribirme">üîî Recibir avisos 72hs antes</a>
          </div>
        </div>
      </div>
    </div>
  </section>

  <div class="grid">
    <div class="card cols-8">
      <div class="cardHeader">
        <h2 class="cardTitle">Sesiones (horario ARG)</h2>
        <p class="cardSub">Hoy / ma√±ana / pr√≥ximo. Sin texto plano: tabla clara.</p>
      </div>
      <div class="cardBody">
        {sessions.length ? (
          <table class="table">
            <thead>
              <tr>
                <th>Sesi√≥n</th>
                <th>Inicio (ARG)</th>
                <th>Fin (ARG)</th>
                <th>Estado</th>
              </tr>
            </thead>
            <tbody>
              {sessions.map((s) => (
                <tr>
                  <td><b>{s.name}</b></td>
                  <td>{fmt(s.start_at)}</td>
                  <td>{fmt(s.end_at)}</td>
                  <td>
                    {s.live ? <span class="badge live">EN VIVO</span> : s.soon ? <span class="badge soon">PR√ìXIMO</span> : <span class="badge">‚Äî</span>}
                  </td>
                </tr>
              ))}
            </tbody>
          </table>
        ) : (
          <div class="small">Sin sesiones a√∫n. Ejecut√° el sync.</div>
        )}
      </div>
    </div>

    <div class="card cols-4">
      <div class="cardHeader">
        <h2 class="cardTitle">Clima (tendencia)</h2>
        <p class="cardSub">Forecast 5 d√≠as (cada 3h) si hay datos sincronizados.</p>
      </div>
      <div class="cardBody">
        {now?.weather ? (
          <div style="display:grid;gap:10px;">
            <div class="badge">Ciudad: {now.weather.city}</div>
            <div class="badge">Actualizado: {fmt(now.weather.updated_at)}</div>
            <div class="small">Tip: mir√° viento/temperatura para entender comportamiento de neum√°ticos.</div>
          </div>
        ) : (
          <div class="note">
            <strong>Clima</strong>
            <div>Si ves ‚ÄúConfigurar OPENWEATHER‚Ä¶‚Äù, corr√© el sync admin (ya lo ten√©s) y esper√° al cron.</div>
          </div>
        )}
      </div>
    </div>

    <div class="cols-12">
      <TrackMap driver={43} />
    </div>

    <div class="card cols-12">
      <div class="cardHeader">
        <h2 class="cardTitle">Noticias relevantes (Colapinto)</h2>
        <p class="cardSub">Esto se actualiza por cron y por sync manual. Abajo, ‚ÄúNotas de la Redacci√≥n‚Äù destacadas.</p>
      </div>
      <div class="cardBody" style="display:grid;gap:12px;">
        {news.items?.length ? news.items.map((n) => (
          <div class="newsCard">
            <div class="newsImg">{n.image_url ? <img src={n.image_url} alt={n.title} loading="lazy" /> : null}</div>
            <div>
              <div class="small"><a href={n.source_url} rel="nofollow">{n.source_name}</a> ¬∑ {fmt(n.published_at)}</div>
              <div style="font-weight:900;margin:6px 0;"><a href={n.url} rel="nofollow">{n.title}</a></div>
              {n.snippet ? <div class="small">{n.snippet}</div> : null}
              {n.auto_note ? (
                <div class="note" style="margin-top:10px;">
                  <strong>Notas de la Redacci√≥n</strong>
                  <div>{n.auto_note}</div>
                </div>
              ) : null}
            </div>
          </div>
        )) : (
          <div class="small">Sin noticias a√∫n. Ejecut√° /api/admin/sync</div>
        )}
        <div style="display:flex;gap:10px;flex-wrap:wrap;">
          <a class="btn primary" href="/noticias">Ver todas</a>
          <a class="btn" href="/gran-premio/bahrain">Detalle GP (demo)</a>
        </div>
      </div>
    </div>
  </div>
</Base>
