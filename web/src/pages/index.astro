---
import Base from "../layouts/Base.astro";

const API = import.meta.env.PUBLIC_API_BASE || "https://colapinto-hub-api.vamosnene.workers.dev";

const nowRes = await fetch(`${API}/api/now`).then(r=>r.json()).catch(()=>null);
const eventsRes = await fetch(`${API}/api/events?season=2026`).then(r=>r.json()).catch(()=>({events:[]}));
const newsRes = await fetch(`${API}/api/news?q=colapinto&limit=6&offset=0`).then(r=>r.json()).catch(()=>({items:[]}));

const current = nowRes?.current;
const next = nowRes?.next;

function fmtAR(iso){
  try{
    return new Intl.DateTimeFormat("es-AR",{ dateStyle:"medium", timeStyle:"short", timeZone:"America/Argentina/Buenos_Aires"}).format(new Date(iso));
  }catch{ return iso; }
}

const next5 = (eventsRes?.events || []).filter(e => new Date(e.end_time) > new Date()).slice(0,5);
---
<Base
  title="Vamos Nene — Colapinto Hub (AR)"
  description="Contexto en vivo, calendario 2026, clima del circuito y noticias de Colapinto (con fuentes)."
  canonical="https://vamosnene.pages.dev/"
>
  <section class="card" style="padding:18px;">
    <div class="badge ok">Argentina · Celeste & Blanco · 43</div>
    <h1 class="h1" style="margin-top:10px;">Colapinto, claro y al día.</h1>
    <p class="p">Vivo (contexto + clima), calendario 2026 en horario ARG, y noticias filtradas con “Notas de la Redacción”.</p>
    <div style="margin-top:12px; display:flex; gap:10px; flex-wrap:wrap;">
      <a class="btn" href="/vivo">Ir a Vivo</a>
      <a class="btn" href="/noticias">Ver Noticias</a>
      <a class="btn" href="/calendario/2026">Calendario 2026</a>
    </div>
  </section>

  <section class="grid grid-3" style="margin-top:14px;">
    <div class="card" style="padding:14px;">
      <div class="badge ok">Ahora</div>
      <div class="hr"></div>
      <div style="font-weight:950; font-size:16px;">{current ? `${current.event_name} — ${current.session_name}` : "Cargando..."}</div>
      <div class="small" style="margin-top:6px;">{current ? `ARG: ${fmtAR(current.start_time)} → ${fmtAR(current.end_time)}` : ""}</div>
      <div style="margin-top:10px;"><a class="btn" href="/vivo">Ver contexto</a></div>
    </div>

    <div class="card" style="padding:14px;">
      <div class="badge hot">Próximo</div>
      <div class="hr"></div>
      <div style="font-weight:950; font-size:16px;">{next ? `${next.event_name} — ${next.session_name}` : "—"}</div>
      <div class="small" style="margin-top:6px;">{next ? `ARG: ${fmtAR(next.start_time)}` : ""}</div>
      <div class="small">{next ? `${next.locality}, ${next.country}` : ""}</div>
    </div>

    <div class="card" style="padding:14px;">
      <div class="badge">Qué vas a ver</div>
      <div class="hr"></div>
      <ul class="ul">
        <li>Estado de la jornada (sin humo).</li>
        <li>Clima del circuito para el finde.</li>
        <li>Noticias con fuente + lectura argentina.</li>
      </ul>
    </div>
  </section>

  <section class="card" style="margin-top:14px; padding:16px;">
    <div style="display:flex; align-items:baseline; justify-content:space-between; gap:10px; flex-wrap:wrap;">
      <h2 class="h2">Últimas noticias (Colapinto)</h2>
      <a class="small" href="/noticias" style="text-decoration:underline;">Ver todas</a>
    </div>
    <div class="hr"></div>

    {(newsRes.items || []).map((n) => (
      <article class="newsItem card" style="box-shadow:none; border:1px solid var(--border); margin-bottom:12px;">
        <img class="thumb" src={n.image_url || "/assets/colapinto-fallback.svg"} alt={n.title} loading="lazy" />
        <div>
          <div class="badge">Fuente: {n.source_name || "RSS"}</div>
          <div style="margin-top:6px; font-weight:950; font-size:16px;">
            <a href={n.url} target="_blank" rel="noopener">{n.title}</a>
          </div>
          <div class="small" style="margin-top:6px;">{n.published_at}</div>
          <div class="p" style="margin-top:8px;">{n.snippet}</div>
          {n.auto_note ? (
            <div class="note"><b>Notas de la Redacción</b><br />{n.auto_note}</div>
          ) : null}
        </div>
      </article>
    ))}

    {(!newsRes.items || newsRes.items.length === 0) ? (
      <div class="small">Todavía no hay notas filtradas. Se actualiza solo (cron).</div>
    ) : null}
  </section>

  <section class="card" style="margin-top:14px; padding:16px;">
    <h2 class="h2">Próximas fechas 2026</h2>
    <div class="small">Horario Argentina. Abrí la ficha del evento.</div>
    <div class="hr"></div>
    <div class="grid grid-2">
      {next5.map((e) => (
        <a class="card" href={`/gran-premio/${e.event_slug}`} style="padding:14px; box-shadow:none; border:1px solid var(--border);">
          <div class="badge">{e.round ? `R${e.round}` : "TEST"}</div>
          <div style="margin-top:8px; font-weight:950;">{e.event_name}</div>
          <div class="small" style="margin-top:6px;">{e.locality}, {e.country} · {fmtAR(e.start_time)}</div>
        </a>
      ))}
    </div>
  </section>
</Base>
