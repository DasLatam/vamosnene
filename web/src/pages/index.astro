---
import Base from "../layouts/Base.astro";

const api = import.meta.env.PUBLIC_API_BASE;

let now: any = null;
let events: any = null;
let news: any = null;

async function safeJson(url: string) {
  try {
    const r = await fetch(url, { headers: { "accept": "application/json" } });
    if (!r.ok) return null;
    return await r.json();
  } catch { return null; }
}

if (api) {
  now = await safeJson(`${api}/api/now`);
  events = await safeJson(`${api}/api/events`);
  news = await safeJson(`${api}/api/news`);
}

function fmtAR(iso?: string) {
  if (!iso) return "";
  const d = new Date(iso);
  if (isNaN(d.getTime())) return String(iso);
  return new Intl.DateTimeFormat("es-AR", { dateStyle:"full", timeStyle:"short", timeZone:"America/Argentina/Buenos_Aires" }).format(d);
}

const headline = now?.current
  ? `EN VIVO: ${now.current.event_name} — ${now.current.session_name}`
  : (now?.next ? `Próximo: ${now.next.event_name} — ${now.next.session_name}` : "Calendario, noticias y guías (Colapinto)");

const topNews = Array.isArray(news?.items) ? news.items.slice(0, 6) : [];
const nextEvents = Array.isArray(events?.events) ? events.events.slice(0, 6) : [];
---
<Base title={`Vamos Nene...!!! — ${headline}`} description="Dashboard y portal F1 para Argentina. Hoy: qué pasa, qué viene y cómo verlo.">
  <div class="card" style="background:linear-gradient(90deg, rgba(103,183,255,.22), rgba(255,255,255,.92));">
    <div class="row" style="justify-content:space-between">
      <div>
        <h1 style="margin:0">Vamos Nene...!!!</h1>
        <p class="muted" style="margin:6px 0 0">
          <strong>Qué hay acá:</strong> <span class="kpi">Vivo</span> (dashboard), <span class="kpi">calendario</span> (horarios ARG), <span class="kpi">noticias</span> (Colapinto) y <span class="kpi">guías</span>.
        </p>
      </div>
      <div class="row">
        <span class="badge"><span class="dot"></span> Identidad ARG · #43</span>
        <a class="btn primary" href="/vivo">Abrir Dashboard Vivo</a>
      </div>
    </div>

    <div class="hr"></div>

    <div class="grid">
      <div class="card" style="box-shadow:none">
        <h2 style="margin-top:0">Estado</h2>
        <div class="badge">{now?.current ? "EN VIVO" : (now?.next ? "PRÓXIMO" : "SIN DATOS")}</div>
        <p class="muted" style="margin-top:10px"><strong>Ahora:</strong> {now?.current ? `${now.current.event_name} — ${now.current.session_name}` : "—"}</p>
        <p class="muted"><strong>Horario ARG:</strong> {now?.current ? `${fmtAR(now.current.start_time)} → ${fmtAR(now.current.end_time)}` : "—"}</p>
        <p class="muted"><strong>Próximo:</strong> {now?.next ? `${now.next.event_name} — ${now.next.session_name} · ${fmtAR(now.next.start_time)}` : "—"}</p>
        <div class="row" style="margin-top:10px">
          <a class="btn" href="/calendario/2026">Ver calendario 2026</a>
          <a class="btn alpine" href="/suscribirme">Avisos 72hs antes</a>
        </div>
      </div>

      <div class="card" style="box-shadow:none">
        <h2 style="margin-top:0">Guía rápida (Argentina)</h2>
        <p class="muted">
          Entrás, ves <strong>qué se corre hoy</strong>, a qué hora en ARG, <strong>dónde verlo</strong> y el clima del circuito.
        </p>
        <div class="row">
          <a class="badge" href="/guias/como-ver-f1-en-argentina">Cómo ver F1 en Argentina</a>
          <a class="badge" href="/guias/colapinto-biografia">Colapinto: bio + historia</a>
          <a class="badge" href="/guias/glosario-f1">Glosario F1</a>
        </div>
      </div>

      <div class="card" style="grid-column:1 / -1; box-shadow:none">
        <h2 style="margin-top:0">Últimas (Colapinto) — con contexto</h2>
        {topNews.length ? (
          <div class="grid">
            {topNews.map((n:any) => (
              <div class="card" style="margin:0; box-shadow:none">
                <div class="badge">Fuente: {n.source || "—"}</div>
                <p style="margin:10px 0 0; font-weight:950">{n.title || "—"}</p>
                <p class="muted" style="margin:8px 0 0">{n.summary || "Sin resumen aún."}</p>
                <div class="row" style="margin-top:10px">
                  {n.url ? <a class="btn" href={n.url} target="_blank" rel="noreferrer">Leer fuente</a> : null}
                  <a class="btn primary" href="/noticias">Ver todas</a>
                </div>
              </div>
            ))}
          </div>
        ) : (
          <p class="muted">Todavía no hay noticias cacheadas. Ejecutá el sync del Worker o esperá al cron.</p>
        )}
      </div>

      <div class="card" style="grid-column:1 / -1; box-shadow:none">
        <h2 style="margin-top:0">Próximos Grandes Premios</h2>
        {nextEvents.length ? (
          <div class="grid">
            {nextEvents.map((e:any) => (
              <div class="card" style="margin:0; box-shadow:none">
                <div class="badge">{e.country || "GP"} · {e.circuit_name || "Circuito"}</div>
                <p style="margin:10px 0 0; font-weight:950">{e.event_name || e.name || "—"}</p>
                <p class="muted" style="margin:6px 0 0">Fecha: {e.date || "—"}</p>
                <div class="row" style="margin-top:10px">
                  <a class="btn" href="/calendario/2026">Ver horarios ARG</a>
                </div>
              </div>
            ))}
          </div>
        ) : (
          <p class="muted">Sin eventos aún. (Se completa con el sync/calendario)</p>
        )}
      </div>
    </div>
  </div>
</Base>
