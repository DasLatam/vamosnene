---
import Base from "../../layouts/Base.astro";
const api = import.meta.env.PUBLIC_API_BASE || "";
const { slug } = Astro.params;

const status = api ? await fetch(`${api}/api/status`).then(r => r.json()).catch(() => null) : null;
const res = api ? await fetch(`${api}/api/event?slug=${encodeURIComponent(slug)}`) : null;
const ev = res ? await res.json() : { sessions: [], weather: null };

const tz = "America/Argentina/Buenos_Aires";
function fmt(iso) {
  if (!iso) return "-";
  return new Intl.DateTimeFormat("es-AR", { dateStyle: "full", timeStyle: "short", timeZone: tz }).format(new Date(iso));
}
---
<Base title={`${ev.sessions?.[0]?.event_name || slug} — Vamos Nene...!!!`} description="Detalle del evento: sesiones + horarios Argentina + clima del circuito + guía de transmisión.">
  <h2>{ev.sessions?.[0]?.event_name || slug}</h2>
  <p class="muted">{ev.sessions?.[0]?.circuit_name || ""} · {ev.sessions?.[0]?.locality || ""} · {ev.sessions?.[0]?.country || ""}</p>

  <div class="card">
    <p><strong>Qué vas a ver:</strong> sesiones oficiales con horario ARG, clima del circuito y links útiles.</p>
    <p><strong>Fuentes:</strong> calendario (Ergast/Jolpica) · clima (OpenWeather) · noticias (RSS con crédito).</p>
    <p class="muted">Actualización: calendario {status?.sync?.schedule ? fmt(status.sync.schedule) : "—"} · clima {status?.sync?.weather ? fmt(status.sync.weather) : "—"}.</p>
  </div>

  <div class="grid">
    <div class="card">
      <h3>Sesiones</h3>
      {ev.sessions?.length ? (
        <ul>
          {ev.sessions.map((s) => (
            <li style="margin:8px 0">
              <strong>{s.session_name}</strong>
              <div class="muted" style="font-size:12px">{fmt(s.start_time)} → {fmt(s.end_time)}</div>
            </li>
          ))}
        </ul>
      ) : <div class="muted">Sin sesiones.</div>}
    </div>

    <div class="card">
      <h3>Clima</h3>
      {ev.weather?.city?.name ? (
        <div>
          <div><strong>{ev.weather.city.name}</strong></div>
          <div class="muted" style="font-size:12px">Actualizado: {ev.weather_fetched_at ? fmt(ev.weather_fetched_at) : "-"}</div>
          <div class="muted" style="margin-top:10px">Forecast (cada 3h, 5 días). Tomalo como tendencia.</div>
        </div>
      ) : (
        <div class="muted">Todavía no hay pronóstico cacheado para este evento. Si ya configuraste OpenWeather, recargá (el API intenta cachear on-demand) o corré el sync.</div>
      )}
    </div>

    <div class="card">
      <h3>Dónde verlo</h3>
      <ul>
        <li><strong>Streaming:</strong> Disney+ (según plan/disponibilidad).</li>
        <li><strong>TV / cable:</strong> señales deportivas (según operador).</li>
        <li><strong>Operadores típicos:</strong> Flow, DirecTV, Telecentro, Movistar (puede variar).</li>
      </ul>
      <p class="muted">Confirmá disponibilidad en tu proveedor: cambia por temporada y plan.</p>
    </div>
  </div>

  <div class="grid">
    <div class="card">
      <h3>Imagen (placeholder)</h3>
      <img src="/img/colapinto.svg" alt="Colapinto placeholder" style="border-radius:14px;border:1px solid rgba(255,255,255,.12)"/>
    </div>
    <div class="card">
      <h3>Alpine (placeholder)</h3>
      <img src="/img/alpine.svg" alt="Alpine placeholder" style="border-radius:14px;border:1px solid rgba(255,255,255,.12)"/>
    </div>
  </div>
</Base>
