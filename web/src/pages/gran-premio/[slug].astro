---
import Base from "../../layouts/Base.astro";
const api = import.meta.env.PUBLIC_API_BASE;

const { slug } = Astro.params;
const r = await fetch(`${api}/api/gp/${slug}`);
const data = await r.json();

function fmt(iso){
  if(!iso) return "";
  const d = new Date(iso);
  if (isNaN(d.getTime())) return String(iso);
  return new Intl.DateTimeFormat("es-AR",{dateStyle:"full",timeStyle:"short",timeZone:"America/Argentina/Buenos_Aires"}).format(d);
}
---
<Base title={`${data?.event?.name ?? "Gran Premio"} â€” Vamos Nene...!!!`} description="Detalle del Gran Premio: sesiones, clima y links Ãºtiles.">
  <section class="hero">
    <div class="heroInner">
      <div>
        <div class="kicker">ğŸ Gran Premio</div>
        <h1 class="h1">{data?.event?.name ?? "Gran Premio"}</h1>
        <p class="p">{data?.event?.circuit_name} Â· {data?.event?.locality} Â· {data?.event?.country}</p>
        <div class="actions">
          <a class="btn primary" href="/vivo">ğŸŸ£ Vivo</a>
          <a class="btn" href="/calendario/2026">ğŸ“… Calendario</a>
          <a class="btn alt" href="/suscribirme">ğŸ”” Suscribirme</a>
        </div>
      </div>
      <div>
        <div class="card" style="height:100%;">
          <div class="cardHeader">
            <h2 class="cardTitle">Clima</h2>
            <p class="cardSub">Si estÃ¡ configurado OpenWeather, se muestra acÃ¡.</p>
          </div>
          <div class="cardBody">
            {data.weather ? (
              <div style="display:grid;gap:10px;">
                <div class="badge">{data.weather.city}</div>
                <div class="badge">Actualizado: {fmt(data.weather.updated_at)}</div>
              </div>
            ) : (
              <div class="note">
                <strong>Clima</strong>
                <div>Si no hay datos, corrÃ© el sync admin y esperÃ¡ el cron.</div>
              </div>
            )}
          </div>
        </div>
      </div>
    </div>
  </section>

  <div class="card" style="margin-top:14px;">
    <div class="cardHeader">
      <h2 class="cardTitle">Sesiones (horario ARG)</h2>
      <p class="cardSub">Tabla clara, sin texto plano.</p>
    </div>
    <div class="cardBody">
      {data.sessions?.length ? (
        <table class="table">
          <thead>
            <tr>
              <th>SesiÃ³n</th>
              <th>Inicio</th>
              <th>Fin</th>
            </tr>
          </thead>
          <tbody>
            {data.sessions.map((s) => (
              <tr>
                <td><b>{s.name}</b></td>
                <td>{fmt(s.start_at)}</td>
                <td>{fmt(s.end_at)}</td>
              </tr>
            ))}
          </tbody>
        </table>
      ) : (
        <div class="small">Sin sesiones aÃºn.</div>
      )}
    </div>
  </div>
</Base>
