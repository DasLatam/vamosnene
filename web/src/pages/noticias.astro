---
import Base from "../layouts/Base.astro";
const api = import.meta.env.PUBLIC_API_BASE;

let news: any = null;

async function safeJson(url: string) {
  try {
    const r = await fetch(url, { headers: { "accept": "application/json" } });
    if (!r.ok) return null;
    return await r.json();
  } catch { return null; }
}

if (api) news = await safeJson(`${api}/api/news`);

const items = Array.isArray(news?.items) ? news.items : [];
---
<Base title="Noticias (Colapinto) — Vamos Nene...!!!" description="Noticias sobre Colapinto con fuentes acreditadas y contexto.">
  <h1>Noticias</h1>
  <p class="muted">
    Qué ves acá: <strong>notas sobre Colapinto</strong> (o relacionadas) con <strong>fuente acreditada</strong> + resumen.
  </p>

  <div class="card">
    <div class="row" style="justify-content:space-between">
      <span class="badge"><span class="dot"></span> Fuentes por RSS / agregadores</span>
      <a class="btn primary" href="/vivo">Volver al Dashboard</a>
    </div>
  </div>

  {items.length ? (
    <div class="grid">
      {items.slice(0, 24).map((n:any)=>(
        <article class="card" style="margin:0">
          <div class="row" style="justify-content:space-between">
            <span class="badge">Fuente: {n.source || "—"}</span>
            <span class="badge">{n.published_at || "—"}</span>
          </div>
          <h2 style="margin:10px 0 6px;font-size:18px">{n.title || "—"}</h2>
          <p class="muted">{n.summary || "Sin resumen aún."}</p>
          {n.editorial_note ? (
            <div class="card" style="margin:10px 0 0; box-shadow:none; border-color:rgba(11,18,32,.10); background:rgba(103,183,255,.12)">
              <strong>Notas de la Redacción</strong>
              <p class="muted" style="margin-top:6px">{n.editorial_note}</p>
            </div>
          ) : null}
          <div class="row" style="margin-top:10px">
            {n.url ? <a class="btn" href={n.url} target="_blank" rel="noreferrer">Leer fuente</a> : null}
          </div>
        </article>
      ))}
    </div>
  ) : (
    <div class="card">
      <p class="muted">Todavía no hay noticias cacheadas. Ejecutá el sync admin del Worker o esperá al cron.</p>
    </div>
  )}
</Base>
